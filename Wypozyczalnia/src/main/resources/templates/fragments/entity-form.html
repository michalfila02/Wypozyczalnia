<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<body>

<div th:fragment="entityForm(actionUrl, formEntity, title, formFields, formValues, foreignKeyOptions, showForm, idFieldName)">
    <div class="panel">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h3 th:text="${title}"></h3>
            <button type="button" class="btn-close" onclick="closeForm()"></button>
        </div>

        <form th:action="${actionUrl}" method="post" th:object="${formEntity}">

            <input type="hidden"
                   th:if="${formEntity != null && formEntity[idFieldName] != null}"
                   th:name="${idFieldName}"
                   th:value="${formEntity[idFieldName]}" />

            <div th:each="fieldEntry : ${formFields}" class="mb-3">
                <label th:for="${fieldEntry.key}"
                       class="form-label"
                       th:text="${#strings.capitalize(fieldEntry.key)}">
                </label>

                <div th:if="${foreignKeyOptions != null && foreignKeyOptions.containsKey(fieldEntry.key)}">
                    <select th:name="${fieldEntry.key}"
                            th:id="${fieldEntry.key}"
                            class="form-select"
                            required>
                        <option value="">-- Select --</option>
                        <option th:each="option : ${foreignKeyOptions.get(fieldEntry.key)}"
                                th:value="${option.key}"
                                th:text="${option.value}"
                                th:selected="${formValues.get(fieldEntry.key) != null && formValues.get(fieldEntry.key).toString().equals(option.key.toString())}">
                        </option>
                    </select>
                </div>

                <div th:unless="${foreignKeyOptions != null && foreignKeyOptions.containsKey(fieldEntry.key)}">
                    <div th:if="${fieldEntry.value == 'checkbox'}" class="form-check">
                        <input type="checkbox"
                               th:name="${fieldEntry.key}"
                               th:id="${fieldEntry.key}"
                               th:checked="${formValues.get(fieldEntry.key) == 'true'}"
                               class="form-check-input" />
                    </div>

                    <textarea th:if="${fieldEntry.value == 'textarea'}"
                              th:name="${fieldEntry.key}"
                              th:id="${fieldEntry.key}"
                              class="form-control"
                              rows="3"
                              th:text="${formValues.get(fieldEntry.key)}">
                    </textarea>

                    <input th:unless="${fieldEntry.value == 'checkbox' || fieldEntry.value == 'textarea'}"
                           th:type="${fieldEntry.value}"
                           th:name="${fieldEntry.key}"
                           th:id="${fieldEntry.key}"
                           th:value="${formValues.get(fieldEntry.key)}"
                           class="form-control" />
                </div>

                <div th:if="${#fields.hasErrors(fieldEntry.key)}" class="text-danger small mt-1">
                    <span th:errors="*{__${fieldEntry.key}__}"></span>
                </div>
            </div>

            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-success">Save</button>
                <button type="button" class="btn btn-secondary" onclick="closeForm()">Cancel</button>
            </div>
        </form>
    </div>
</div>

<style>
    #popupFormOverlay .panel {
        max-height: 80vh;
        overflow-y: auto;
    }
</style>

</body>
</html>